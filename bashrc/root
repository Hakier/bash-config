#!/bin/bash

export LC_ALL='C'

function message {
    message="${1}"
    time="${2}"

    if [ "${time}" == '' ]; then
        time=3
    fi

    export DISPLAY=:0.0
    su hakier -c "kdialog --passivepopup '${message}' ${time}"
}

alias rl='source ~/.bashrc'
alias app='aptitude install'
alias apps='aptitude search'
alias appu='aptitude update; aptitude upgrade'
alias a2rt='service apache2 restart'
alias a2rl='service apache2 reload'
alias a2up='service apache2 start'
alias a2down='service apache2 stop'
alias xdon='php5enmod xdebug; a2rt'
alias xdoff='php5dismod xdebug; a2rt'
alias xa0="sed '/autostart/s/^/;/' /etc/php5/mods-available/xdebug.ini -i; a2rt; message 'xdebug autostart OFF' 1"
alias xa1="sed '/autostart/s/^;*//' /etc/php5/mods-available/xdebug.ini -i; a2rt; message 'xdebug autostart ON' 1"
alias scr='hqScreen root'
alias nig='npm install --global'

function hqForward {
    srcAddr="${1}"
    srcPort=80
    apacheAddr="${2}"
    apachePort=80
    flag="${3}"

    echo 'iptables clean'

    iptables -F
    iptables -t nat -F
    iptables -X

    if [ "${flag}" = '-a' ]; then
            echo 'forward start'
            echo 1 > /proc/sys/net/ipv4/ip_forward
            a2down
            iptables -t nat -A PREROUTING -p tcp --dport "${srcPort}" -j DNAT --to-destination "${apacheAddr}:${apachePort}"
            iptables -t nat -A POSTROUTING -p tcp -d "${apacheAddr}" --dport "${apachePort}" -j SNAT --to-source "${srcAddr}"
    else
            echo 'forward stop'
            echo 0 > /proc/sys/net/ipv4/ip_forward
            a2up
    fi
}

alias forward='hqForward 192.168.11.121 192.168.11.120'
## Generated by iptables-save v1.4.21 on Thu Aug  6 07:40:08 2015
#*nat
#:PREROUTING ACCEPT [15:1994]
#:INPUT ACCEPT [15:1994]
#:OUTPUT ACCEPT [52:8363]
#:POSTROUTING ACCEPT [52:8363]
#-A PREROUTING -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.11.120:80
#-A POSTROUTING -d 192.168.11.120/32 -p tcp -m tcp --dport 80 -j SNAT --to-source 192.168.11.121
#COMMIT
## Completed on Thu Aug  6 07:40:08 2015
## Generated by iptables-save v1.4.21 on Thu Aug  6 07:40:08 2015
#*filter
#:INPUT ACCEPT [6430:6728864]
#:FORWARD ACCEPT [0:0]
#:OUTPUT ACCEPT [5500:481726]
#COMMIT
## Completed on Thu Aug  6 07:40:08 2015


######POLIGON
## Generated by iptables-save v1.4.21 on Thu Aug  6 07:40:23 2015
#*nat
#:PREROUTING ACCEPT [0:0]
#:INPUT ACCEPT [0:0]
#:OUTPUT ACCEPT [0:0]
#:POSTROUTING ACCEPT [0:0]
#-A PREROUTING -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.11.121:80
#-A POSTROUTING -d 192.168.11.121/32 -p tcp -m tcp --dport 80 -j SNAT --to-source 192.168.11.120
#COMMIT
## Completed on Thu Aug  6 07:40:23 2015
## Generated by iptables-save v1.4.21 on Thu Aug  6 07:40:23 2015
#*filter
#:INPUT ACCEPT [24:1528]
#:FORWARD ACCEPT [0:0]
#:OUTPUT ACCEPT [14:1536]
#COMMIT
## Completed on Thu Aug  6 07:40:23 2015
